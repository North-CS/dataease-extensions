package io.dataease.plugins.datasource.dremio.query;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import io.dataease.plugins.common.base.domain.DatasetTableField;
import io.dataease.plugins.common.base.domain.Datasource;
import io.dataease.plugins.datasource.dremio.provider.DremioDsProvider;
import junit.framework.TestCase;

import javax.sql.DataSource;
import java.util.List;

public class DremioQueryProviderTest extends TestCase {


    public void testCreateQueryTableWithLimit() {
    }

    public void testCreateQueryTableWithPage() {
        DremioQueryProvider queryProvider = new DremioQueryProvider();

        String f = "[{\"accuracy\":0,\"checked\":true,\"columnIndex\":0,\"dataeaseName\":\"C_b80bb7740288fda1f201890375a60c8f\",\"deExtractType\":0,\"deType\":0,\"extField\":0,\"groupType\":\"d\",\"id\":\"8d818803-ba0d-457d-8135-c1493ea600ed\",\"lastSyncTime\":1700191577312,\"name\":\"id\",\"originName\":\"id\",\"size\":65536,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"CHARACTER VARYING\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":1,\"dataeaseName\":\"C_99bea2cd698b56b1a3b8c1701bd51c67\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"857293a5-40b7-4d4e-8779-78d3ebf7c005\",\"lastSyncTime\":1700191577312,\"name\":\"pv\",\"originName\":\"pv\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":2,\"dataeaseName\":\"C_a3b34c0871dc2fd51eec5559b68f709d\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"4267e9e1-c0a9-4732-94b9-3c59f6d67e2c\",\"lastSyncTime\":1700191577312,\"name\":\"play\",\"originName\":\"play\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":3,\"dataeaseName\":\"C_a7dd12b1dab17d25467b0b0a4c8d4a92\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"c288c4b9-8986-4c9d-b5c4-cd624d1e5fe7\",\"lastSyncTime\":1700191577312,\"name\":\"show\",\"originName\":\"show\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":4,\"dataeaseName\":\"C_1bc33012992b99a3b7fc01faaedd04e1\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"4817b6d7-6fbe-49c7-a930-bb2e022b83a0\",\"lastSyncTime\":1700191577312,\"name\":\"upvote\",\"originName\":\"upvote\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":5,\"dataeaseName\":\"C_06d4cd63bde972fc66a0aed41d2f5c51\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"ef6da5cf-6185-47d3-b320-99ddbdb9c3f7\",\"lastSyncTime\":1700191577312,\"name\":\"comment\",\"originName\":\"comment\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":6,\"dataeaseName\":\"C_be1ab1632e4285edc3733b142935c60b\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"9b150623-9f22-4582-909b-f7dd5f31004e\",\"lastSyncTime\":1700191577312,\"name\":\"like\",\"originName\":\"like\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":7,\"dataeaseName\":\"C_0788a6922bd5f9f130e7ed8980193bab\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"ee7c4374-380a-4f69-813c-62a70a3426c0\",\"lastSyncTime\":1700191577312,\"name\":\"collect\",\"originName\":\"collect\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":8,\"dataeaseName\":\"C_85e47ac07ac9d6416168a97e33fa969a\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"7c015b86-f76e-4c60-8ec1-53eb547cde64\",\"lastSyncTime\":1700191577312,\"name\":\"share\",\"originName\":\"share\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":9,\"dataeaseName\":\"C_e0ab074e8104870583f417cbd8afa027\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"25389663-c5ff-409e-8e88-29a1bdfdb03c\",\"lastSyncTime\":1700191577312,\"name\":\"reaction\",\"originName\":\"reaction\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":10,\"dataeaseName\":\"C_920b9115ef920ff411c979dd5a684be2\",\"deExtractType\":2,\"deType\":2,\"extField\":0,\"groupType\":\"q\",\"id\":\"8c128a2a-ec4e-45e6-a065-36d6feba3919\",\"lastSyncTime\":1700191577312,\"name\":\"re_pin\",\"originName\":\"re_pin\",\"size\":32,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"INTEGER\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":11,\"dataeaseName\":\"C_d5d3db1765287eef77d7927cc956f50a\",\"deExtractType\":0,\"deType\":0,\"extField\":0,\"groupType\":\"d\",\"id\":\"dc97d772-7568-41fd-ac5d-9005dac01718\",\"lastSyncTime\":1700191577312,\"name\":\"title\",\"originName\":\"title\",\"size\":65536,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"CHARACTER VARYING\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":12,\"dataeaseName\":\"C_0faea619a3eb6dfca4ced9bbe5bf4c9a\",\"deExtractType\":0,\"deType\":0,\"extField\":0,\"groupType\":\"d\",\"id\":\"03ac6814-7ef8-4c7e-83d5-50868e33b305\",\"lastSyncTime\":1700191577312,\"name\":\"publish_time\",\"originName\":\"publish_time\",\"size\":65536,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"CHARACTER VARYING\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":13,\"dataeaseName\":\"C_bb5855f0349346ae0b19eb381f00ab70\",\"deExtractType\":1,\"deType\":1,\"extField\":0,\"groupType\":\"d\",\"id\":\"fd66ab32-ac3a-47ba-a745-9a7e44f78d6b\",\"lastSyncTime\":1700191577312,\"name\":\"created_time\",\"originName\":\"created_time\",\"size\":10,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"DATE\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":14,\"dataeaseName\":\"C_2a304a1348456ccd2234cd71a81bd338\",\"deExtractType\":0,\"deType\":0,\"extField\":0,\"groupType\":\"d\",\"id\":\"556c5896-3e62-49e7-acd7-4da230487c6a\",\"lastSyncTime\":1700191577312,\"name\":\"link\",\"originName\":\"link\",\"size\":65536,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"CHARACTER VARYING\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":15,\"dataeaseName\":\"C_ee11cbb19052e40b07aac0ca060c23ee\",\"deExtractType\":0,\"deType\":0,\"extField\":0,\"groupType\":\"d\",\"id\":\"729af11d-9cd7-4167-97b7-ca781ce1393a\",\"lastSyncTime\":1700191577312,\"name\":\"user\",\"originName\":\"user\",\"size\":65536,\"tableId\":\"084c718d-85e9-422b-9ac5-4c307263f5c7\",\"type\":\"CHARACTER VARYING\"}]";

        String ds = "{\"configuration\":\"{\\\"initialPoolSize\\\":5,\\\"extraParams\\\":\\\"\\\",\\\"minPoolSize\\\":5,\\\"maxPoolSize\\\":50,\\\"maxIdleTime\\\":30,\\\"acquireIncrement\\\":5,\\\"idleConnectionTestPeriod\\\":5,\\\"connectTimeout\\\":5,\\\"customDriver\\\":\\\"default\\\",\\\"queryTimeout\\\":30,\\\"username\\\":\\\"zq\\\",\\\"password\\\":\\\"Calong@2015\\\",\\\"host\\\":\\\"10.1.13.137\\\",\\\"port\\\":\\\"31010\\\",\\\"dataBase\\\":\\\"dataease\\\"}\",\"createBy\":\"admin\",\"createTime\":1698824378958,\"id\":\"7ae5ee76-f5a1-4d18-9c53-5d37648e2565\",\"name\":\"dremio\",\"status\":\"Success\",\"type\":\"dremio\",\"updateTime\":1698824378958}";

        try {
            String res = queryProvider.createQueryTableWithPage("date_test", JSONObject.parseArray(f, DatasetTableField.class), 1, 1000, 1000, false, JSONObject.parseObject(ds, Datasource.class), null, null);
            System.out.println(res);
        } catch (Exception exception) {
            System.out.println("");
        }
        // No such group file: pluginSqltemplate.stg

    }

    public void testCreateQuerySQLWithPage() {
        DremioQueryProvider queryProvider = new DremioQueryProvider();
        String sql = "SELECT \"prod_bondscale_month\".\"DIMENSION_metric_time_month\" AS f_e282febf3a112fb3,\"prod_bondscale_month\".\"METRIC_prod_hldp_par_scale_end\" AS f_38e0c66ddaeabab3,\"prod_bondscale_month\".\"METRIC_prod_hldp_mval_scale_end\" AS f_99106459660a967c,\"bondscale_uncitybond_month\".\"METRIC_prod_hldp_par_scale_end\" AS f_0fd1cbbd9be8a344,\"bondscale_uncitybond_month\".\"METRIC_prod_hldp_mval_scale_end\" AS f_338adf7d5b1cb8c7 FROM \"prod_bondscale_month\"  LEFT JOIN  \"bondscale_uncitybond_month\" ON \"prod_bondscale_month\".\"DIMENSION_metric_time_month\" = \"bondscale_uncitybond_month\".\"DIMENSION_metric_time_month";

        List<DatasetTableField> fields = JSONObject.parseArray("[{\"deType\":1,\"groupType\":\"d\",\"lastSyncTime\":1700619452499,\"dataeaseName\":\"C_a416dfccfef90082e93d36ecde85357d\",\"dateFormat\":\"\",\"accuracy\":0,\"type\":\"DATE\",\"deExtractType\":1,\"size\":50,\"name\":\"日期\",\"checked\":true,\"extField\":0,\"tableId\":\"f480ce4a-dda7-4416-99a1-1dedab712b72\",\"columnIndex\":0,\"id\":\"c809944d-30a5-4154-8ed8-ea4b8ccd864b\",\"dateFormatType\":\"\",\"originName\":\"DIMENSION_metric_time_month\"},{\"deType\":3,\"groupType\":\"q\",\"lastSyncTime\":1700619452499,\"dataeaseName\":\"C_68062a2ba611a47daa52fd25a742dc14\",\"dateFormat\":\"\",\"accuracy\":0,\"type\":\"DOUBLE\",\"deExtractType\":3,\"size\":24,\"name\":\"券面总规模\",\"checked\":true,\"extField\":0,\"tableId\":\"f480ce4a-dda7-4416-99a1-1dedab712b72\",\"columnIndex\":1,\"id\":\"6e7acfab-fb0c-42c9-b9ae-a9e0b3a31128\",\"dateFormatType\":\"\",\"originName\":\"METRIC_prod_hldp_par_scale_end\"},{\"deType\":3,\"groupType\":\"q\",\"lastSyncTime\":1700619452499,\"dataeaseName\":\"C_afa86f4a64df100eaef9000b63c23e99\",\"dateFormat\":\"\",\"accuracy\":0,\"type\":\"DECIMAL\",\"deExtractType\":3,\"size\":22,\"name\":\"市值总规模\",\"checked\":true,\"extField\":0,\"tableId\":\"f480ce4a-dda7-4416-99a1-1dedab712b72\",\"columnIndex\":2,\"id\":\"39092f72-d60c-42b7-ac76-1d3411e4fbdc\",\"dateFormatType\":\"\",\"originName\":\"METRIC_prod_hldp_mval_scale_end\"},{\"deType\":3,\"groupType\":\"q\",\"lastSyncTime\":1700619452499,\"dataeaseName\":\"C_efe81eeae0f7dcf93374844150dddb59\",\"dateFormat\":\"\",\"accuracy\":0,\"type\":\"DOUBLE\",\"deExtractType\":3,\"size\":24,\"name\":\"城投债券面总规模\",\"checked\":true,\"extField\":0,\"tableId\":\"f480ce4a-dda7-4416-99a1-1dedab712b72\",\"columnIndex\":3,\"id\":\"2addb430-9808-4a85-83c0-c046d0f7cdff\",\"dateFormatType\":\"\",\"originName\":\"METRIC_prod_hldp_par_scale_end0\"},{\"deType\":3,\"groupType\":\"q\",\"lastSyncTime\":1700619452499,\"dataeaseName\":\"C_85c24122acd77dc59a961b10d5e59b90\",\"dateFormat\":\"\",\"accuracy\":0,\"type\":\"DECIMAL\",\"deExtractType\":3,\"size\":22,\"name\":\"非城投债市值总规模\",\"checked\":true,\"extField\":0,\"tableId\":\"f480ce4a-dda7-4416-99a1-1dedab712b72\",\"columnIndex\":4,\"id\":\"8f895a08-7195-4e76-9ede-07311b12057d\",\"dateFormatType\":\"\",\"originName\":\"METRIC_prod_hldp_mval_scale_end0\"}]", DatasetTableField.class);

        try {
            String res = queryProvider.createQuerySQLWithPage(sql, fields, 1, 1000, 1000, false, null, null);
            System.out.println(res);
        } catch (Exception exception) {
            System.out.println("");
        }
    }



    public void testCreateQuerySQLWithPage2() {
        DremioQueryProvider queryProvider = new DremioQueryProvider();
        String sql = "SELECT \"testzq_2\".\"title\" AS f_8067755566a3ec5a,\"testzq_2\".\"created_time\" AS f_bec66e2e7f0e5dfd,\"t_zhihu_answer\".\"title\" AS f_aff0c72eab84040e FROM \"testzq_2\"  LEFT JOIN  \"t_zhihu_answer\" ON \"testzq_2\".\"created_time\" = \"t_zhihu_answer\".\"created_time\"";

        String str = "[{\"accuracy\":0,\"checked\":true,\"columnIndex\":0,\"dataeaseName\":\"C_2a64c75cbe2a92dffc66e7a56232faa3\",\"deExtractType\":0,\"deType\":0,\"extField\":0,\"groupType\":\"d\",\"id\":\"024bf191-4e18-41e4-b966-a51e0ff3de7b\",\"lastSyncTime\":1700638244084,\"name\":\"title\",\"originName\":\"f_8067755566a3ec5a\",\"size\":65536,\"tableId\":\"c49a58c0-0eb2-4383-95a7-8524c4137c49\",\"type\":\"CHARACTER VARYING\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":1,\"dataeaseName\":\"C_1edefc782e6b8a63e6fa97ee4d06adf2\",\"deExtractType\":1,\"deType\":1,\"extField\":0,\"groupType\":\"d\",\"id\":\"0405c1f1-a0d8-4470-b371-82582476eb24\",\"lastSyncTime\":1700638244084,\"name\":\"created_time\",\"originName\":\"f_bec66e2e7f0e5dfd\",\"size\":23,\"tableId\":\"c49a58c0-0eb2-4383-95a7-8524c4137c49\",\"type\":\"TIMESTAMP\"},{\"accuracy\":0,\"checked\":true,\"columnIndex\":2,\"dataeaseName\":\"C_5eaa461b16674d61eab60677fab713e5\",\"deExtractType\":0,\"deType\":0,\"extField\":0,\"groupType\":\"d\",\"id\":\"e4319879-938c-4c29-96c6-3015cd32c511\",\"lastSyncTime\":1700638244084,\"name\":\"title\",\"originName\":\"f_aff0c72eab84040e\",\"size\":65536,\"tableId\":\"c49a58c0-0eb2-4383-95a7-8524c4137c49\",\"type\":\"CHARACTER VARYING\"}]";
        List<DatasetTableField> fields = JSONObject.parseArray(str, DatasetTableField.class);

        try {
            String res = queryProvider.createQuerySQLWithPage(sql, fields, 1, 1000, 1000, false, null, null);
            System.out.println(res);
        } catch (Exception exception) {
            System.out.println("");
        }
    }
}
